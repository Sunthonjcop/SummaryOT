<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อมูลโอที</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for improved aesthetics and responsiveness */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2fe; /* Light blue background for a fresh look */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 1rem; /* Responsive padding */
            position: relative; /* For loading overlay */
        }
        .container {
            background-color: #ffffff;
            border-radius: 1.5rem; /* More rounded corners */
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15); /* Stronger shadow for depth */
            padding: 2rem; /* Consistent padding */
            width: 100%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem; /* Consistent spacing */
        }
        h1 {
            color: #1a202c; /* Darker text for headings */
        }
        h3, h4 {
            color: #2d3748; /* Slightly lighter dark text for subheadings */
        }

        /* Calendar Grid adjustments for responsiveness */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem; /* Slightly smaller gap for mobile */
        }
        .calendar-header, .calendar-day {
            text-align: center;
            padding: 0.5rem 0; /* Adjusted padding */
            border-radius: 0.75rem; /* Rounded corners for cells */
            font-size: 0.875rem; /* Base font size for calendar text */
        }
        .calendar-header {
            background-color: #bfdbfe; /* Light blue header */
            font-weight: bold;
            color: #2b6cb0; /* Darker blue text */
        }
        .calendar-day {
            background-color: #e0f2fe; /* Lighter blue for default days */
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 4.5rem; /* Adjusted min-height for better mobile fit */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 0.3rem;
            border: 2px solid transparent; /* Default transparent border */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        .calendar-day:hover {
            background-color: #90cdf4; /* Hover effect */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .calendar-day.selected {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            box-shadow: 0 6px 12px rgba(59, 130, 246, 0.4);
            border-color: #3b82f6 !important; /* Ensure selected color takes precedence */
        }

        /* Shift-specific border colors */
        .calendar-day.has-day-shift {
            border-color: #fbbf24; /* Tailwind amber-400 for Day Shift */
        }
        .calendar-day.has-night-shift {
            border-color: #38b2ac; /* Tailwind teal-500 for Night Shift */
        }
        /* Ensure selected state overrides shift borders */
        .calendar-day.selected.has-day-shift,
        .calendar-day.selected.has-night-shift {
            border-color: #3b82f6 !important; /* Keep selected color */
        }

        .day-number {
            font-size: 1rem; /* Slightly smaller day number for mobile */
            font-weight: 700; /* Bolder day number */
            color: #2d3748;
        }
        .calendar-day.selected .day-number {
            color: white; /* White day number when selected */
        }
        .ot-indicator {
            font-size: 0.65rem; /* Smaller OT indicator text */
            color: #10b981; /* Green color for OT indicator */
            margin-top: 0.2rem;
            line-height: 1.2;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
            padding: 0 2px;
        }
        .calendar-day.selected .ot-indicator {
            color: #d1fae5; /* Lighter green/white for OT indicator when selected */
        }

        /* Button Group Styling */
        .button-group button {
            transition: all 0.2s ease;
            font-weight: 600;
            border-radius: 0.5rem;
            padding: 0.75rem 1.25rem;
            background-color: #e2e8f0;
            color: #4a5568;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .button-group button:hover {
            background-color: #cbd5e0;
        }
        .button-group button.active {
            background-color: #10b981; /* Tailwind emerald-500 */
            color: white;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.4);
            transform: translateY(-2px);
        }

        /* Input Field Styling */
        input[type="number"], input[type="text"] {
            border: 1px solid #cbd5e0; /* Light gray border */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            color: #2d3748;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #4299e1; /* Blue on focus */
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.5); /* Blue ring on focus */
        }

        /* Table Styling */
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            padding: 0.75rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #edf2f7; /* Lighter border for table rows */
        }
        th {
            background-color: #ebf8ff; /* Light blue for table headers */
            color: #4a5568;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        tbody tr:hover {
            background-color: #f7fafc; /* Subtle hover for table rows */
        }
        .summary-table-input {
            width: 100% !important; /* Ensure full width on mobile */
            text-align: right;
            padding: 0.5rem 0.75rem; /* Smaller padding for inputs in tables */
            font-size: 0.9rem; /* Smaller font for inputs in tables */
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 1.5rem;
            color: #2b6cb0;
            border-radius: 1.5rem;
        }

        /* Responsive adjustments for overall layout */
        @media (max-width: 768px) {
            body {
                padding: 0.5rem; /* Reduce overall padding on small screens */
            }
            .container {
                padding: 1rem; /* Smaller padding on very small screens */
            }
            .ot-input-section, .summary-section {
                flex-direction: column; /* Stack sections vertically */
                gap: 1rem; /* Consistent gap */
            }
            .ot-input-section > div, .summary-section > div {
                width: 100%; /* Ensure full width */
            }
            .button-group {
                flex-direction: column; /* Stack buttons vertically on small screens */
            }
            .button-group button {
                width: 100%; /* Full width buttons */
                margin-bottom: 0.5rem; /* Space between stacked buttons */
            }
            .button-group button:last-child {
                margin-bottom: 0;
            }
            .flex.gap-4 { /* For add/clear buttons */
                flex-direction: column;
            }
            .flex.gap-4 button {
                width: 100%;
            }
            .text-3xl { /* Adjust heading sizes for smaller screens */
                font-size: 2rem;
            }
            .text-2xl {
                font-size: 1.5rem;
            }
            .text-xl {
                font-size: 1.25rem;
            }
            .text-lg {
                font-size: 1rem;
            }
            th, td {
                padding: 0.5rem 0.75rem; /* Smaller padding in tables */
                font-size: 0.8rem; /* Smaller font size in tables */
            }
            .grand-total-text {
                font-size: 1.5rem !important; /* Adjust grand total font size */
            }
            .calendar-day {
                min-height: 4rem; /* Further reduce height for very small screens */
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase instances
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.isFirebaseInitialized = false;

        // Firebase Configuration (YOUR ACTUAL Firebase config)
        // IMPORTANT: DO NOT share your API Key publicly if this is a real application.
        // For this personal tool, it's generally acceptable.
        const firebaseConfig = {
          apiKey: "AIzaSyBq3ewj-MZJ8bTw3XniUz-YShGgRahGD70",
          authDomain: "summaryot-ce6cb.firebaseapp.com",
          projectId: "summaryot-ce6cb",
          storageBucket: "summaryot-ce6cb.firebasestorage.app",
          messagingSenderId: "197272976667",
          appId: "1:197272976667:web:27182869f7232ea41de7be",
          measurementId: "G-83NRY6HVVZ"
        };
        // We will use Project ID as the appId for data storage path
        const appId = firebaseConfig.projectId;
        // initialAuthToken is null when running on GitHub Pages
        const initialAuthToken = null;

        // Initialize Firebase and authenticate
        async function initializeFirebase() {
            try {
                // Check if firebaseConfig is properly filled
                if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey || firebaseConfig.apiKey === "YOUR_API_KEY") {
                    console.error("Firebase config is missing or incomplete. Cannot initialize Firebase.");
                    document.getElementById('loadingOverlay').textContent = "ข้อผิดพลาด: ไม่สามารถเชื่อมต่อ Firebase ได้ (ขาดการตั้งค่า)";
                    return;
                }

                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // Listen for auth state changes
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid;
                        window.isFirebaseInitialized = true;
                        console.log("Firebase initialized and user authenticated:", window.userId);
                        await window.loadOtData(); // Load data once authenticated
                        document.getElementById('loadingOverlay').style.display = 'none'; // Hide loading overlay
                    } else {
                        // Sign in anonymously if no user is found
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(window.auth, initialAuthToken);
                            } else {
                                await signInAnonymously(window.auth);
                            }
                        } catch (error) {
                            console.error("Firebase authentication failed:", error);
                            document.getElementById('loadingOverlay').textContent = `ข้อผิดพลาดในการยืนยันตัวตน: ${error.message}`;
                        }
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('loadingOverlay').textContent = `ข้อผิดพลาดในการเริ่มต้น Firebase: ${error.message}`;
            }
        }

        // Expose Firebase functions to global scope for use in main script
        window.getFirestore = getFirestore;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;

        // Call initialization when the window loads
        window.addEventListener('load', initializeFirebase);
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center p-4 min-h-screen">
    <div class="loading-overlay" id="loadingOverlay">
        กำลังโหลดข้อมูล...
    </div>

    <div class="container bg-white rounded-2xl shadow-xl p-8 max-w-4xl w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">ระบบบันทึกข้อมูลโอที</h1>

        <!-- Calendar Navigation -->
        <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 shadow-md">
                เดือนก่อนหน้า
            </button>
            <h2 id="currentMonthYear" class="text-2xl font-semibold text-gray-700"></h2>
            <button id="nextMonth" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition duration-200 shadow-md">
                เดือนถัดไป
            </button>
        </div>

        <!-- Calendar Display -->
        <div id="calendar" class="calendar-grid mb-8">
            <!-- Days of the week header -->
            <div class="calendar-header">อาทิตย์</div>
            <div class="calendar-header">จันทร์</div>
            <div class="calendar-header">อังคาร</div>
            <div class="calendar-header">พุธ</div>
            <div class="calendar-header">พฤหัสบดี</div>
            <div class="calendar-header">ศุกร์</div>
            <div class="calendar-header">เสาร์</div>
            <!-- Calendar days will be generated here by JavaScript -->
        </div>

        <!-- OT Input Section -->
        <div class="ot-input-section flex flex-col md:flex-row gap-6 mb-8">
            <div class="flex-1 p-6 bg-blue-50 rounded-xl shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">บันทึกโอทีสำหรับวันที่: <span id="selectedDateDisplay" class="text-blue-600">โปรดเลือกวัน</span></h3>

                <div class="mb-4">
                    <label for="salaryInput" class="block text-gray-700 text-sm font-bold mb-2">เงินเดือน (บาท):</label>
                    <input type="number" id="salaryInput" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="ใส่เงินเดือนของคุณ" value="16000">
                </div>

                <!-- Shift Selection -->
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">เลือกกะทำงาน:</label>
                    <div id="shiftButtons" class="button-group flex gap-3 flex-wrap">
                        <button data-shift="Day" class="flex-1 min-w-[80px] px-5 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Day Shift</button>
                        <button data-shift="Night" class="flex-1 min-w-[80px] px-5 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Night Shift</button>
                    </div>
                </div>

                <!-- Display existing OT for selected day -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-600 mb-2">โอทีที่บันทึกสำหรับวันนี้:</h4>
                    <div id="dailyOtEntries" class="bg-white p-4 rounded-lg shadow-sm max-h-40 overflow-y-auto">
                        <p class="text-gray-500">ยังไม่มีโอทีสำหรับวันนี้</p>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2">เลือกอัตราโอที:</label>
                    <div id="otRateButtons" class="button-group flex gap-3 flex-wrap">
                        <button data-rate="1.5" class="flex-1 min-w-[80px] px-5 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">1.5 แรง</button>
                        <button data-rate="2" class="flex-1 min-w-[80px] px-5 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">2 แรง</button>
                        <button data-rate="3" class="flex-1 min-w-[80px] px-5 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">3 แรง</button>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="hoursInput" class="block text-gray-700 text-sm font-bold mb-2">จำนวนชั่วโมงโอที:</label>
                    <input type="number" id="hoursInput" class="shadow appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="ใส่จำนวนชั่วโมง" min="0" step="0.5">
                </div>

                <div class="flex gap-4">
                    <button id="addOtButton" class="flex-1 bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-200 shadow-md">
                        เพิ่มโอที
                    </button>
                    <button id="clearOtDayButton" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 transition duration-200 shadow-md">
                        ลบโอทีวันนี้
                    </button>
                </div>
            </div>

            <!-- Summary Section -->
            <div class="flex-1 p-6 bg-green-50 rounded-xl shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">สรุปข้อมูลโอที (เดือนปัจจุบัน)</h3>

                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-600 mb-2">จำนวนชั่วโมงโอทีแต่ละแรง:</h4>
                    <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-sm">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">แรงโอที</th>
                                <th class="py-3 px-6 text-right">ชั่วโมง</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm font-light">
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">1.5 แรง</td>
                                <td id="summaryHours1_5" class="py-3 px-6 text-right">0.0</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">2 แรง</td>
                                <td id="summaryHours2" class="py-3 px-6 text-right">0.0</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">3 แรง</td>
                                <td id="summaryHours3" class="py-3 px-6 text-right">0.0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-600 mb-2">จำนวนวันสรุป:</h4>
                    <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-sm">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">รายละเอียด</th>
                                <th class="py-3 px-6 text-right">จำนวนวัน</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm font-light">
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">กะ Night Shift</td>
                                <td id="nightShiftDaysCount" class="py-3 px-6 text-right">0</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">ค่าอาหารโอที</td>
                                <td id="otMealAllowanceDaysCount" class="py-3 px-6 text-right">0</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-600 mb-2">สรุปยอดเงินโอทีแยกตามแรง:</h4>
                    <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-sm">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">รายละเอียด</th>
                                <th class="py-3 px-6 text-right">จำนวนเงิน (บาท)</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm font-light">
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">โอที 1.5 แรง</td>
                                <td id="earnings1_5" class="py-3 px-6 text-right">0.00</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-right">โอที 2 แรง</td>
                                <td id="earnings2" class="py-3 px-6 text-right">0.00</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-right">โอที 3 แรง</td>
                                <td id="earnings3" class="py-3 px-6 text-right">0.00</td>
                            </tr>
                            <tr class="border-t border-gray-200">
                                <td class="py-3 px-6 text-left whitespace-nowrap font-bold">ยอดรวมโอที (จากชั่วโมง)</td>
                                <td id="totalOtEarnings" class="py-3 px-6 text-right font-bold text-lg text-green-700">0.00</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">ค่ากะกลางคืน</td>
                                <td id="nightShiftAllowance" class="py-3 px-6 text-right">0.00</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">ค่าอาหารโอที</td>
                                <td id="otMealAllowance" class="py-3 px-6 text-right">0.00</td>
                            </tr>
                        </tbody>
                    </table>
                    <p class="text-xs text-gray-500 mt-2 text-right">คำนวณโอทีจาก: (เงินเดือน / 166) × (ชั่วโมงรวม × แรงโอที)</p>
                    <p class="text-xs text-gray-500 text-right">ค่ากะกลางคืน: 230 บาท/วัน</p>
                    <p class="text-xs text-gray-500 text-right">ค่าอาหารโอที: 84 บาท/วัน (ถ้ามีโอที) + 20 บาท (ถ้าโอที > 1 ชม. และเป็นกะกลางคืน)</p>
                </div>

                <!-- New Total Income Summary Section -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-600 mb-2">สรุปรายรับรวม:</h4>
                    <table class="min-w-full bg-white rounded-lg overflow-hidden shadow-sm">
                        <thead>
                            <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">รายละเอียด</th>
                                <th class="py-3 px-6 text-right">จำนวนเงิน (บาท)</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-700 text-sm font-light">
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">เงินเดือน</td>
                                <td id="totalIncomeSalary" class="py-3 px-6 text-right">0.00</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">เงินรวมโอที</td>
                                <td id="totalIncomeOtEarnings" class="py-3 px-6 text-right">0.00</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-right whitespace-nowrap">เบี้ยขยัน</td>
                                <td class="py-3 px-6 text-right">
                                    <input type="number" id="attendanceBonusInput" class="summary-table-input" value="0" min="0" step="10">
                                </td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">เงินค่าอาหาร (ประจำ)</td>
                                <td class="py-3 px-6 text-right">
                                    <input type="number" id="regularMealAllowanceInput" class="summary-table-input" value="0" min="0" step="10">
                                </td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">เงินค่ากะ Night</td>
                                <td id="totalIncomeNightShiftAllowance" class="py-3 px-6 text-right">0.00</td>
                            </tr>
                            <tr class="border-b border-gray-200 hover:bg-gray-50">
                                <td class="py-3 px-6 text-left whitespace-nowrap">เงินค่าอาหารโอที</td>
                                <td id="totalIncomeOtMealAllowance" class="py-3 px-6 text-right">0.00</td>
                            </tr>
                            <tr class="border-t-2 border-gray-300">
                                <td class="py-3 px-6 text-left whitespace-nowrap font-bold text-lg text-lime-700">ยอดรวมรายรับทั้งหมด</td>
                                <td id="grandTotalIncome" class="py-3 px-6 text-right font-bold text-2xl text-lime-600 grand-total-text">0.00</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Global variables for current date and OT data
        let currentYear, currentMonth; // 0-indexed month (0 = Jan, 11 = Dec)
        let selectedDate = null; // Stores the selected date in 'YYYY-MM-DD' format
        // otData now stores an object for each day, containing shift and an array of OT entries
        let otData = {}; // {'YYYY-MM-DD': {shift: 'Day' | 'Night' | null, entries: [{hours: 4, rate: 1.5}, {hours: 3, rate: 2}]}}
        let selectedOtRate = null; // Stores the currently selected OT rate (1.5, 2, or 3)
        let selectedShift = null; // Stores the currently selected shift ('Day' or 'Night')

        // DOM Elements
        const calendarEl = document.getElementById('calendar');
        const currentMonthYearEl = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const selectedDateDisplayEl = document.getElementById('selectedDateDisplay');
        const salaryInput = document.getElementById('salaryInput');
        const shiftButtons = document.getElementById('shiftButtons'); // Element for shift buttons
        const dailyOtEntriesEl = document.getElementById('dailyOtEntries');
        const otRateButtons = document.getElementById('otRateButtons');
        const hoursInput = document.getElementById('hoursInput');
        const addOtButton = document.getElementById('addOtButton');
        const clearOtDayButton = document.getElementById('clearOtDayButton');
        const summaryHours1_5 = document.getElementById('summaryHours1_5');
        const summaryHours2 = document.getElementById('summaryHours2');
        const summaryHours3 = document.getElementById('summaryHours3');
        const nightShiftDaysCountEl = document.getElementById('nightShiftDaysCount'); // New element
        const otMealAllowanceDaysCountEl = document.getElementById('otMealAllowanceDaysCount'); // New element
        const earnings1_5 = document.getElementById('earnings1_5');
        const earnings2 = document.getElementById('earnings2');
        const earnings3 = document.getElementById('earnings3');
        const totalOtEarningsEl = document.getElementById('totalOtEarnings');
        const nightShiftAllowanceEl = document.getElementById('nightShiftAllowance');
        const otMealAllowanceEl = document.getElementById('otMealAllowance');
        
        // New elements for Total Income Summary
        const attendanceBonusInput = document.getElementById('attendanceBonusInput');
        const regularMealAllowanceInput = document.getElementById('regularMealAllowanceInput');
        const totalIncomeSalaryEl = document.getElementById('totalIncomeSalary');
        const totalIncomeOtEarningsEl = document.getElementById('totalIncomeOtEarnings');
        const totalIncomeNightShiftAllowanceEl = document.getElementById('totalIncomeNightShiftAllowance');
        const totalIncomeOtMealAllowanceEl = document.getElementById('totalIncomeOtMealAllowance');
        const grandTotalIncomeEl = document.getElementById('grandTotalIncome');
        const loadingOverlay = document.getElementById('loadingOverlay');


        // Initialize with current date
        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth();

        // Firebase related functions (exposed globally by the module script)
        // window.db, window.auth, window.userId, window.isFirebaseInitialized,
        // window.getFirestore, window.doc, window.getDoc, window.setDoc

        // Function to load OT data from Firestore
        window.loadOtData = async function() {
            if (!window.isFirebaseInitialized || !window.userId) {
                console.log("Firebase not initialized or userId not available yet.");
                // Keep loading overlay if Firebase isn't ready
                return;
            }
            loadingOverlay.style.display = 'flex'; // Show loading overlay
            loadingOverlay.textContent = 'กำลังโหลดข้อมูล...'; // Ensure text is correct
            try {
                // Use the global 'appId' variable here
                const docRef = window.doc(window.db, `artifacts/${appId}/users/${window.userId}/otTrackerData/mainData`);
                const docSnap = await window.getDoc(docRef);

                if (docSnap.exists()) {
                    const loadedData = docSnap.data();
                    otData = loadedData.data || {}; // Load the 'data' field
                    // Also load salary, attendanceBonus, regularMealAllowance if saved
                    salaryInput.value = loadedData.salary !== undefined ? loadedData.salary : 16000;
                    attendanceBonusInput.value = loadedData.attendanceBonus !== undefined ? loadedData.attendanceBonus : 0;
                    regularMealAllowanceInput.value = loadedData.regularMealAllowance !== undefined ? loadedData.regularMealAllowance : 0;

                    console.log("Data loaded from Firestore:", otData);
                } else {
                    console.log("No existing data found in Firestore for this user. Resetting inputs.");
                    otData = {};
                    // Reset inputs to default if no data
                    salaryInput.value = 16000;
                    attendanceBonusInput.value = 0;
                    regularMealAllowanceInput.value = 0;
                }
            } catch (error) {
                console.error("Error loading data from Firestore:", error);
                // Display error to user if needed
                loadingOverlay.textContent = `ข้อผิดพลาดในการโหลดข้อมูล: ${error.message}`;
            } finally {
                loadingOverlay.style.display = 'none'; // Hide loading overlay
                // Always render and update summary after attempting to load
                renderCalendar();
                updateSummary();
            }
        };

        // Function to save OT data to Firestore
        async function saveOtData() {
            if (!window.isFirebaseInitialized || !window.userId) {
                console.warn("Firebase not initialized or userId not available. Data will not be saved.");
                return;
            }
            loadingOverlay.style.display = 'flex'; // Show saving overlay
            loadingOverlay.textContent = 'กำลังบันทึกข้อมูล...';
            try {
                // Use the global 'appId' variable here
                const docRef = window.doc(window.db, `artifacts/${appId}/users/${window.userId}/otTrackerData/mainData`);
                // Save otData, salary, attendanceBonus, regularMealAllowance
                await window.setDoc(docRef, {
                    data: otData,
                    salary: parseFloat(salaryInput.value) || 0,
                    attendanceBonus: parseFloat(attendanceBonusInput.value) || 0,
                    regularMealAllowance: parseFloat(regularMealAllowanceInput.value) || 0
                }, { merge: true }); // Save the entire otData object
                console.log("Data saved to Firestore successfully.");
            } catch (error) {
                console.error("Error saving data to Firestore:", error);
                // Display error to user if needed
            } finally {
                loadingOverlay.style.display = 'none'; // Hide saving overlay
                loadingOverlay.textContent = 'กำลังโหลดข้อมูล...'; // Reset text for next load
            }
        }


        // Function to render the calendar for a given month and year
        function renderCalendar() {
            // Clear previous calendar days but keep headers
            calendarEl.innerHTML = `
                <div class="calendar-header">อาทิตย์</div>
                <div class="calendar-header">จันทร์</div>
                <div class="calendar-header">อังคาร</div>
                <div class="calendar-header">พุธ</div>
                <div class="calendar-header">พฤหัสบดี</div>
                <div class="calendar-header">ศุกร์</div>
                <div class="calendar-header">เสาร์</div>
            `;

            // Set current month and year display
            const monthNames = [
                "มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน",
                "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"
            ];
            currentMonthYearEl.textContent = `${monthNames[currentMonth]} ${currentYear}`;

            // Get the first day of the month and number of days in the month
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const startingDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday, etc.

            // Add empty divs for days before the first day of the month
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'bg-gray-50', 'cursor-default');
                calendarEl.appendChild(emptyDay);
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateString = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEl = document.createElement('div');
                dayEl.classList.add('calendar-day', 'rounded-xl', 'shadow-sm');
                dayEl.dataset.date = dateString;

                let otInfoHtml = '';
                const dayData = otData[dateString];

                // Remove existing shift classes before applying new ones to ensure correct display
                dayEl.classList.remove('has-day-shift', 'has-night-shift');

                if (dayData) {
                    // Apply shift-specific border color
                    if (dayData.shift === 'Day') {
                        dayEl.classList.add('has-day-shift');
                    } else if (dayData.shift === 'Night') {
                        dayEl.classList.add('has-night-shift');
                    }

                    if (dayData.entries && dayData.entries.length > 0) {
                        // Calculate total hours for the day to display in the calendar cell
                        const totalHoursToday = dayData.entries.reduce((sum, entry) => sum + entry.hours, 0);
                        otInfoHtml += `<div class="ot-indicator">${totalHoursToday.toFixed(1)} ชม.</div>`;
                    }
                }

                dayEl.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${otInfoHtml}
                `;

                // Add click event listener to select the date
                dayEl.addEventListener('click', () => selectDate(dateString));
                calendarEl.appendChild(dayEl);
            }

            // Re-select the date if it's still in the current month
            if (selectedDate) {
                const [selYear, selMonth, selDay] = selectedDate.split('-').map(Number);
                if (selYear === currentYear && selMonth === (currentMonth + 1)) {
                    document.querySelector(`.calendar-day[data-date="${selectedDate}"]`)?.classList.add('selected');
                } else {
                    // Clear selection if month changed
                    selectedDate = null;
                    selectedDateDisplayEl.textContent = 'โปรดเลือกวัน';
                    hoursInput.value = '';
                    document.querySelectorAll('#otRateButtons button').forEach(btn => btn.classList.remove('active'));
                    selectedOtRate = null;
                    document.querySelectorAll('#shiftButtons button').forEach(btn => btn.classList.remove('active'));
                    selectedShift = null; // Clear selected shift
                    renderDailyOtEntries(); // Clear daily entries display
                }
            }
        }

        // Function to select a date
        function selectDate(dateString) {
            // Remove 'selected' class from previously selected day
            const previouslySelected = document.querySelector('.calendar-day.selected');
            if (previouslySelected) {
                previouslySelected.classList.remove('selected');
            }

            // Add 'selected' class to the new selected day
            const currentSelected = document.querySelector(`.calendar-day[data-date="${dateString}"]`);
            if (currentSelected) {
                currentSelected.classList.add('selected');
            }

            selectedDate = dateString;
            selectedDateDisplayEl.textContent = formatDate(dateString);

            // Reset input fields
            hoursInput.value = '';
            document.querySelectorAll('#otRateButtons button').forEach(btn => btn.classList.remove('active'));
            selectedOtRate = null;

            // Reset shift buttons and set selectedShift based on existing data
            document.querySelectorAll('#shiftButtons button').forEach(btn => btn.classList.remove('active'));
            selectedShift = null; // Reset selectedShift

            if (otData[dateString] && otData[dateString].shift) {
                selectedShift = otData[dateString].shift;
                document.querySelector(`#shiftButtons button[data-shift="${selectedShift}"]`)?.classList.add('active');
            }

            renderDailyOtEntries(); // Render existing OT entries for the selected day
        }

        // Function to display OT entries for the selected day
        function renderDailyOtEntries() {
            dailyOtEntriesEl.innerHTML = ''; // Clear previous entries

            if (selectedDate && otData[selectedDate]) {
                const dayData = otData[selectedDate];
                const otEntries = dayData.entries || [];

                const ul = document.createElement('ul');
                ul.classList.add('list-disc', 'pl-5', 'space-y-1');

                // Display shift information
                if (dayData.shift) {
                    const shiftLi = document.createElement('li');
                    shiftLi.classList.add('text-blue-700', 'font-semibold');
                    shiftLi.textContent = `กะ: ${dayData.shift === 'Day' ? 'กลางวัน' : 'กลางคืน'}`;
                    ul.appendChild(shiftLi);
                }

                if (otEntries.length > 0) {
                    otEntries.forEach(entry => {
                        const li = document.createElement('li');
                        li.classList.add('text-gray-700');
                        li.textContent = `${entry.hours} ชั่วโมง @ ${entry.rate} แรง`;
                        ul.appendChild(li);
                    });
                } else if (!dayData.shift) { // Only show "no OT" if no shift is set either
                    dailyOtEntriesEl.innerHTML = '<p class="text-gray-500">ยังไม่มีโอทีสำหรับวันนี้</p>';
                    return; // Exit if no OT and no shift
                }
                dailyOtEntriesEl.appendChild(ul);

            } else {
                dailyOtEntriesEl.innerHTML = '<p class="text-gray-500">ยังไม่มีโอทีสำหรับวันนี้</p>';
            }
        }

        // Helper function to format date for display
        function formatDate(dateString) {
            const [year, month, day] = dateString.split('-');
            return `${parseInt(day)}/${parseInt(month)}/${year}`;
        }

        // Function to update summary tables
        function updateSummary() {
            let totalHours1_5 = 0;
            let totalHours2 = 0;
            let totalHours3 = 0;

            let earnings1_5_total = 0;
            let earnings2_total = 0;
            let earnings3_total = 0;
            let overallOtEarnings = 0; // Sum of OT earnings only

            let nightShiftAllowanceTotal = 0;
            let otMealAllowanceTotal = 0;
            let nightShiftDaysCount = 0; // New counter
            let otMealAllowanceDaysCount = 0; // New counter
            
            // New variables for total income summary
            const salary = parseFloat(salaryInput.value) || 0;
            const attendanceBonus = parseFloat(attendanceBonusInput.value) || 0;
            const regularMealAllowance = parseFloat(regularMealAllowanceInput.value) || 0;
            let grandTotalIncome = 0;


            const hourlyRate = salary / 166; // Assuming 166 working hours per month for calculation

            // Loop through all recorded dates, but only process those in the current month and year
            for (const dateString in otData) {
                const [year, month, day] = dateString.split('-').map(Number);

                // Check if the date falls within the currently displayed month and year
                if (year === currentYear && (month - 1) === currentMonth) { // month-1 because currentMonth is 0-indexed
                    const dayData = otData[dateString];
                    const otEntries = dayData.entries || [];
                    const shift = dayData.shift;

                    let dailyOtHours = 0; // To check for meal allowance for this specific day

                    otEntries.forEach(ot => {
                        dailyOtHours += ot.hours;
                        if (ot.rate === 1.5) {
                            totalHours1_5 += ot.hours;
                            earnings1_5_total += ot.hours * ot.rate * hourlyRate;
                        } else if (ot.rate === 2) {
                            totalHours2 += ot.hours;
                            earnings2_total += ot.hours * ot.rate * hourlyRate;
                        } else if (ot.rate === 3) {
                            totalHours3 += ot.hours;
                            earnings3_total += ot.hours * ot.rate * hourlyRate;
                        }
                    });

                    // Calculate Night Shift Allowance for this day
                    if (shift === 'Night') {
                        nightShiftAllowanceTotal += 230;
                        nightShiftDaysCount++; // Increment night shift day count
                    }

                    // Calculate OT Meal Allowance for this day based on new rules
                    if (dailyOtHours > 0) { // If there's any OT on this day (even 0.5 hr)
                        otMealAllowanceTotal += 84; // Base 84 Baht
                        otMealAllowanceDaysCount++; // Count this day for meal allowance
                        if (dailyOtHours > 1 && shift === 'Night') { // If OT > 1 hr AND Night Shift
                            otMealAllowanceTotal += 20; // Add additional 20 Baht
                        }
                    }
                }
            }

            overallOtEarnings = earnings1_5_total + earnings2_total + earnings3_total;
            
            // Calculate grand total income
            grandTotalIncome = salary + overallOtEarnings + attendanceBonus + regularMealAllowance + nightShiftAllowanceTotal + otMealAllowanceTotal;


            // Update summary hours
            summaryHours1_5.textContent = totalHours1_5.toFixed(1);
            summaryHours2.textContent = totalHours2.toFixed(1);
            summaryHours3.textContent = totalHours3.toFixed(1);

            // Update new day counters
            nightShiftDaysCountEl.textContent = nightShiftDaysCount;
            otMealAllowanceDaysCountEl.textContent = otMealAllowanceDaysCount;

            // Update earnings per rate
            earnings1_5.textContent = earnings1_5_total.toFixed(2);
            earnings2.textContent = earnings2_total.toFixed(2);
            earnings3.textContent = earnings3_total.toFixed(2);
            totalOtEarningsEl.textContent = overallOtEarnings.toFixed(2);

            // Update new allowances and grand total
            nightShiftAllowanceEl.textContent = nightShiftAllowanceTotal.toFixed(2);
            otMealAllowanceEl.textContent = otMealAllowanceTotal.toFixed(2);

            // Update new Total Income Summary
            totalIncomeSalaryEl.textContent = salary.toFixed(2);
            totalIncomeOtEarningsEl.textContent = overallOtEarnings.toFixed(2);
            totalIncomeNightShiftAllowanceEl.textContent = nightShiftAllowanceTotal.toFixed(2);
            totalIncomeOtMealAllowanceEl.textContent = otMealAllowanceTotal.toFixed(2);
            grandTotalIncomeEl.textContent = grandTotalIncome.toFixed(2);


            // Re-render calendar to update OT indicators (total hours per day, night shift indicator)
            renderCalendar();
        }

        // Event Listeners

        // Navigate to previous month
        prevMonthBtn.addEventListener('click', async () => { // Made async to await saveOtData
            await saveOtData(); // Save current month's data before changing month
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            await window.loadOtData(); // Load data for the new month
        });

        // Navigate to next month
        nextMonthBtn.addEventListener('click', async () => { // Made async to await saveOtData
            await saveOtData(); // Save current month's data before changing month
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            await window.loadOtData(); // Load data for the new month
        });

        // OT Rate buttons click handler
        otRateButtons.addEventListener('click', (event) => {
            if (event.target.tagName === 'BUTTON') {
                document.querySelectorAll('#otRateButtons button').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                selectedOtRate = parseFloat(event.target.dataset.rate);
            }
        });

        // Shift buttons click handler
        shiftButtons.addEventListener('click', async (event) => { // Made async to await saveOtData
            if (event.target.tagName === 'BUTTON') {
                document.querySelectorAll('#shiftButtons button').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                selectedShift = event.target.dataset.shift; // 'Day' or 'Night'

                // If a date is selected, update its shift property in otData
                if (selectedDate) {
                    if (!otData[selectedDate]) {
                        otData[selectedDate] = { entries: [], shift: selectedShift };
                    } else {
                        otData[selectedDate].shift = selectedShift;
                    }
                    renderDailyOtEntries(); // Update display to show shift
                    updateSummary(); // Recalculate summary
                    await saveOtData(); // Save data after shift change
                }
            }
        });


        // Add OT data button
        addOtButton.addEventListener('click', async () => { // Made async to await saveOtData
            if (!selectedDate) {
                alert('โปรดเลือกวันที่ต้องการบันทึกโอที');
                return;
            }
            if (!selectedOtRate) {
                alert('โปรดเลือกอัตราโอที (1.5, 2, หรือ 3 แรง)');
                return;
            }
            const hours = parseFloat(hoursInput.value);
            if (isNaN(hours) || hours <= 0) {
                alert('โปรดใส่จำนวนชั่วโมงโอทีที่ถูกต้อง');
                return;
            }

            // Ensure otData[selectedDate] exists and has an 'entries' array
            if (!otData[selectedDate]) {
                // If no data for the day, initialize with current selected shift (or null if none selected)
                otData[selectedDate] = { entries: [], shift: selectedShift };
            } else if (!otData[selectedDate].entries) {
                otData[selectedDate].entries = []; // Ensure entries array exists
            }

            // If a shift hasn't been set for the day, set it now from selectedShift
            // This ensures that if you add OT without explicitly selecting a shift first,
            // it uses the last selected shift.
            if (selectedShift && !otData[selectedDate].shift) {
                otData[selectedDate].shift = selectedShift;
            }


            otData[selectedDate].entries.push({ hours: hours, rate: selectedOtRate });
            alert(`เพิ่มโอทีสำหรับวันที่ ${formatDate(selectedDate)}: ${hours} ชั่วโมง, ${selectedOtRate} แรง`);

            // Clear input fields after adding
            hoursInput.value = '';
            document.querySelectorAll('#otRateButtons button').forEach(btn => btn.classList.remove('active'));
            selectedOtRate = null;

            renderDailyOtEntries(); // Update the list of entries for the current day
            updateSummary(); // Recalculate and update summary tables
            await saveOtData(); // Save data after adding OT
        });

        // Clear OT for selected day button
        clearOtDayButton.addEventListener('click', async () => { // Made async to await saveOtData
            if (!selectedDate) {
                alert('โปรดเลือกวันที่ต้องการลบโอที');
                return;
            }

            if (otData[selectedDate]) {
                const confirmClear = confirm(`คุณต้องการลบโอทีและข้อมูลกะทั้งหมดสำหรับวันที่ ${formatDate(selectedDate)} ใช่หรือไม่?`);
                if (confirmClear) {
                    delete otData[selectedDate]; // Remove the entire entry for this date
                    alert(`ลบโอทีและข้อมูลกะทั้งหมดสำหรับวันที่ ${formatDate(selectedDate)} แล้ว`);
                    renderDailyOtEntries(); // Clear daily entries display
                    // Reset input fields and shift selection
                    hoursInput.value = '';
                    document.querySelectorAll('#otRateButtons button').forEach(btn => btn.classList.remove('active'));
                    selectedOtRate = null;
                    document.querySelectorAll('#shiftButtons button').forEach(btn => btn.classList.remove('active'));
                    selectedShift = null; // Clear selected shift
                    updateSummary(); // Recalculate and update summary tables
                    await saveOtData(); // Save data after clearing OT for the day
                }
            } else {
                alert('ไม่มีโอทีสำหรับวันที่เลือกที่จะลบ');
            }
        });

        // Salary input change handler (recalculate earnings when salary changes)
        salaryInput.addEventListener('input', async () => {
            updateSummary();
            await saveOtData(); // Save data when salary changes
        });
        
        // New event listeners for attendance bonus and regular meal allowance inputs
        attendanceBonusInput.addEventListener('input', async () => {
            updateSummary();
            await saveOtData(); // Save data when attendance bonus changes
        });
        regularMealAllowanceInput.addEventListener('input', async () => {
            updateSummary();
            await saveOtData(); // Save data when regular meal allowance changes
        });


        // Initial render and summary update is now handled by Firebase initialization success
        // renderCalendar(); // Removed, called by loadOtData
        // updateSummary();  // Removed, called by loadOtData
    </script>
</body>
</html>

